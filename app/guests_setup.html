<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title data-translate="title-guests">Willem Tell - Gasten</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="./assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="./assets/css/fontawesome.min.css" />

    <script>if (typeof module === 'object') {window.module = module; module = undefined;}
    </script>
    <!-- Bootstrap Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="./assets/js/jquery-3.6.4.min.js"></script>
    <script src="./assets/js/jquery-ui.min.js"></script>
    <script src="./assets/js/popper.min.js"></script>
    <script src="./assets/js/bootstrap.min.js"></script>
    <script src="./assets/js/translate.js"></script>
    <script>if (window.module) module = window.module;</script>
  </head>
  <style>
    .btn-next, .btn-back {
        font-size: 20px;
        margin-bottom: 5px;
        width: 95%;
    }
  </style>
  <body style="overflow-y: auto;">
    <div id="app" style="display: none; margin:20px;">
        <form class="form-horizontal">
          <fieldset>
            
          <!-- Form Name -->
          <legend data-translate="guest-archers">Gasten schieten</legend>
            
            <!-- Text input-->
          <div class="row">
            <div class="form-group col-sm-12 col-md-4 col-xl-2">
              <label class="control-label" for="date" data-translate="date">Datum</label>
              <div class="">
                <input id="date" name="date" type="date" class="form-control input-md" required="">
              </div>
            </div>
            
            <!-- Text input-->
            <div class="form-group col-sm-6 col-md-3 col-xl-1 teams">
              <label class="control-label" for="teams" data-translate="teams">Teams</label>
              <div class="">
                <input id="teams" name="teams" type="number" min="1" max="5" step="1" placeholder="Teams" data-translate-placeholder="teams" class="form-control input-md" required="">
              </div>
            </div>

            <!-- Text input-->
            <div class="form-group col-sm-6 col-md-3 col-xl-2 arrows">
              <label class="control-label" for="arrows" data-translate="arrows-turn">Pijlen/beurt</label> <span data-toggle="tooltip" style="cursor:help; user-select: none;" title="Aantal Pijlen voordat ze weer gehaald worden" data-translate-title="arrows-per-turn-i">&#8505;</span>
              <div class="">
                <input id="arrows" name="arrows" type="number" min="1" max="10" step="1" placeholder="Pijlen" data-translate-placeholder="arrows" class="form-control input-md" required="">
              </div>
            </div>

            <!-- Text input-->
            <div class="form-group col-sm-6 col-md-3 col-xl-2 turns">
              <label class="control-label" for="turns" data-translate="turns-round">Beurten/ronde</label> <span data-toggle="tooltip" style="cursor:help; user-select: none;" title="Hoeveel beurten voordat schutters wisselen?" data-translate-title="turns-per-round-i">&#8505;</span>
              <div class="">
                <input id="turns" name="turns" type="number" min="1" max="30" step="1" placeholder="Beurten" data-translate-placeholder="turns" class="form-control input-md" required="">
              </div>
            </div>

            <!-- Text input-->
            <div class="form-group col-sm-6 col-md-3 col-xl-1 rounds">
              <label class="control-label" for="rounds" data-translate="rounds">Rondes</label> <span data-toggle="tooltip" style="cursor:help; user-select: none;" title="Gebruik 0 rondes om een competitie te doen." data-translate-title="rounds-0">&#8505;</span>
              <div class="">
                <input id="rounds" name="rounds" type="number" min="0" max="10" step="1" value="2" class="form-control input-md" required="">
              </div>
            </div>

            <!-- Text input-->
            <div class="form-group col-sm-6 col-md-3 col-xl-2 minmax">
              <label class="control-label" for="score_min" data-translate="min-score">Min Score</label> <span data-toggle="tooltip" style="cursor:help; user-select: none;" title="Minimum punten die per pijl geschoten kunnen worden" data-translate-title="min-score-i">&#8505;</span>
              <div class="">
                <input id="score_min" name="score_min" type="number" min="1" max="10" step="1" placeholder="1" class="form-control input-md" required="">
              </div>
            </div>

            <!-- Text input-->
            <div class="form-group col-sm-6 col-md-3 col-xl-2 minmax">
              <label class="control-label" for="score_max" data-translate="max-score">Max Score</label> <span data-toggle="tooltip" style="cursor:help; user-select: none;" title="Maximum punten die per pijl geschoten kunnen worden" data-translate-title="max-score-i">&#8505;</span>
              <div class="">
                <input id="score_max" name="score_max" type="number" min="10" max="100" step="1" placeholder="10" class="form-control input-md" required="">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="form-group col-sm-12 col-md-4 col-xl-4">
              <label class="control-label" for="group" data-translate="group">Groep</label> <span data-toggle="tooltip" style="cursor:help; user-select: none;" title="Selecteer een groep, of vul de naam in voor een nieuwe groep" data-translate-title="group-i">&#8505;</span>
              <div class="">
                <input id="group" name="group" list="groups" class="form-select" onchange="getGuests(this)" required="">
                <datalist id="groups"></datalist>
              </div>
            </div>
            <div class="form-group col-sm-12 col-md-8 col-xl-8">
              <label class="control-label" for="first_name" data-translate="add-player">Nieuwe Schutter</label> <span data-toggle="tooltip" style="cursor:help; user-select: none;" title="Vul de voornaam in. Achternaam is niet verplicht." data-translate-title="add-player-i">&#8505;</span>
              <div class="input-group">
                <input id="first_name" class="form-control" placeholder="Voornaam" data-translate-placeholder="firstname" disabled="" />
                <input id="last_name" class="form-control" placeholder="Achternaam" data-translate-placeholder="lastname" disabled="" />
                <button class="btn btn-primary" type="button" onclick="addPlayer()" data-translate="ok">Ok</button>
              </div>
            </div>
          </div>
          <div class="row" style="margin-top:20px;">
            <label class="control-label" for="players" data-translate="players-today">Wie spelen er vandaag mee?</label>
            <div id="players"></div>
          </div>
          <div class="row" style="margin-top: 24px;">
            <div class="col-2"><button class="btn btn-success btn-back" data-translate="back">Terug</button></div>
            <div class="col-10"><button id="submitForm" type="submit" class="btn btn-success btn-next"><b data-translate="next">Volgende</b></button></div>
          </div>

          <input name="competition" type="hidden" value="1" />
          <input name="count_average" type="hidden" value="0" />
          <input name="team_type" type="hidden" value="random" />
        </fieldset>
      </form>
    </div>
    <script src="app.js"></script>
    <script>
        const ipc = window.require('electron').ipcRenderer;

        setUpLanguages('nl-NL', 'nl-NL', ["en-US", "nl-NL"], "./lang/");
        ipc.send("getLanguage", false);
        ipc.on("gotLanguage", (event, lang) => {
          setTimeout(function() {
            changeLanguage(lang);
            $(function(){ $('[data-toggle="tooltip"]').tooltip() }) // ENABLE TOOLTIP FUNCTION (after translation is set)
          }, 5);
        });

        document.getElementById('date').valueAsDate = new Date();

        function serialize(data) {
        	let obj = {};
          for (let [key, value] of data) {
            if (obj[key] !== undefined) {
              if (!Array.isArray(obj[key])) {
                obj[key] = [obj[key]];
              }
              obj[key].push(value);
            } else {
              obj[key] = value;
            }
          }
          return obj;
        }

        document.querySelector(".btn-back").addEventListener(
          "click",
          event => {
            event.preventDefault();
            ipc.send('gotoPage', 'app.html');
          },
          false
        );

        const form = document.querySelector("form");
        document.querySelector("#submitForm").addEventListener(
          "click",
          event => {
            event.preventDefault();
            let delay = 0;
            if (document.getElementById("first_name").value != "") {
              addPlayer();
              delay = 250;
            }
            if (!form.checkValidity()) {
              form.reportValidity();
            } else {
              // Start loading animation
              document.querySelector("#submitForm").innerHTML = '<span class="spinner-border spinner-border" role="status" aria-hidden="true"></span> &nbsp;' + getTranslation("loading");
              setTimeout(sendForm, delay);
            }
          },
          false
        );
        function sendForm() {
          let formData = new FormData(form);
          //console.log(serialize(formData));
          ipc.send('setCompetition', serialize(formData));
        }
        // Stop loading animation
        ipc.on('gotPlayers', function(event) {
          document.querySelector("#submitForm").innerHTML = '<b>' + getTranslation("next") + '</b>';
        });

        ipc.send('getAllFrom', 'settings');
        ipc.on('gotAllFrom_settings', function(event, settings) {
          sets = ['teams','arrows','turns','rounds','score_min','score_max'];
          settings.forEach(setting => {
            if (sets.indexOf(setting.setting) != -1) {
              //console.log(setting.setting + ' - ' + setting.value);
              document.querySelector("#" + setting.setting).value = setting.value;
            }
          });
        });

        ipc.send('getAllFrom', 'groups');
        ipc.on('gotAllFrom_groups', function(event, groups) {
          groups.forEach(group => {
            document.querySelector("#groups").innerHTML += '<option data-id="' + group.group_id + '" value="' + group.group_name + '"></option>';
          });
        });

        function addPlayer() {
          var first_name = document.getElementById("first_name").value;
          var last_name = document.getElementById("last_name").value;
          var group_name = document.getElementById("group").value;
          if (first_name != "" && group_name != "") {
            ipc.send('addGuest', { group_name: group_name, first_name: first_name, last_name: last_name });
          }
        }
        function delPlayer(id, name) {
          var del = confirm('Delete ' + name + '?');
          if (del) ipc.send('delGuest', id);
        }
        ipc.on('deletedGuest', function(event, id) {
          document.getElementById("player_" + id).remove();
        });

        function getGuests(elem) {
          var options = document.getElementById('groups').getElementsByTagName('option');
          var optionVals = [];
          for (let i=0; i < options.length; i++) optionVals.push(options[i].value);
          if (optionVals.indexOf(elem.value) == -1) {
            ipc.send('addGroup', elem.value);
          }
          var group_name = document.getElementById("group").value;
          if (group_name != "") {
            ipc.send('getActivePlayers', group_name);
          } else {
            document.querySelector("#players").innerHTML = '';
            document.querySelector("#first_name").disabled = true;
            document.querySelector("#last_name").disabled = true;
          }
        }
        function addGuest(guest) {
          var insert = '<div class="btn-group-toggle" data-toggle="buttons" style="float:left; margin-right:10px; margin-bottom:10px;" id="player_' + guest.id + '">\
                            <label class="btn btn-success active">\
                            <input type="checkbox" name="players" value="' + guest.id + '" checked autocomplete="off">\
                            ' + guest.first_name + ' ' + guest.last_name + '<a class="remove-user text-muted" href="#" onclick="delPlayer(' + guest.id + ',\'' + guest.first_name + ' ' + guest.last_name + '\')"><i class="fas fa-trash"></i></a></label>\
                            </div>';
          document.querySelector("#players").innerHTML += insert;
        }
        ipc.on('addedGuest', function(event, guest) {
          addGuest(guest);
          document.querySelector("#first_name").value = '';
          document.querySelector("#last_name").value = '';
        });
        ipc.on('gotActivePlayers', function(event, guests) {
          guests.forEach(guest => {
            addGuest(guest);
          });
          document.querySelector("#first_name").disabled = false;
          document.querySelector("#last_name").disabled = false;
        });
    </script>
  </body>
</html>